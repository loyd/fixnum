#[cfg(not(feature = "std"))]
extern crate alloc;
#[cfg(not(feature = "std"))]
use alloc::format;

use anyhow::Result;
#[cfg(feature = "i128")]
use proptest::prelude::*;

use crate::TestCaseResult;

#[test]
#[allow(overflowing_literals)]
fn from_good_str_exact() -> Result<()> {
    test_fixed_point! {
        case (input: &str, expected: Layout) => {
            let expected = FixedPoint::from_bits(expected);
            let exact = FixedPoint::from_str_exact(input)?;
            assert_eq!(exact, expected);

            // A rounding version must return same result.
            let inexact: FixedPoint = input.parse()?;
            assert_eq!(inexact, exact);

            #[cfg(feature = "serde")]
            assert_eq!(serde_json::from_str::<FixedPoint>(&format!("\"{}\"", input))?, expected);
            #[cfg(feature = "serde")]
            assert_eq!(serde_json::from_str::<FixedPoint>(&format!("\"{}\"", exact))?, expected);
        },
        fp64 {
            ("1", 1000000000);
            ("1.1", 1100000000);
            ("1.02", 1020000000);
            ("-1.02", -1020000000);
            ("+1.02", 1020000000);
            ("0.1234", 123400000);
            ("-0.1234", -123400000);
            ("123456789.123456789", 123456789123456789);
            ("9223372036.854775807", 9223372036854775807);
            ("-9223372036.854775808", -9223372036854775808);

            ("1e0", 1000000000);
            ("1E0", 1000000000);
            ("+1E+0", 1000000000);
            ("-1E+0", -1000000000);
            ("1E-0", 1000000000);
            ("-1E-0", -1000000000);

            ("110E-2", 1100000000);
            ("11E-1", 1100000000);
            ("1.1E0", 1100000000);
            ("0.11E1", 1100000000);
            ("0.011E+2", 1100000000);

            ("-110E-2", -1100000000);
            ("-11E-1", -1100000000);
            ("-1.1E0", -1100000000);
            ("-0.11E1", -1100000000);
            ("-0.011E+2", -1100000000);

            ("1020e-3", 1020000000);
            ("102e-2", 1020000000);
            ("10.2e-1", 1020000000);
            ("1.02e0", 1020000000);
            ("0.102e1", 1020000000);
            ("0.0102e2", 1020000000);

            ("-1020e-3", -1020000000);
            ("-102e-2", -1020000000);
            ("-10.2e-1", -1020000000);
            ("-1.02e0", -1020000000);
            ("-0.102e1", -1020000000);
            ("-0.0102e2", -1020000000);

            ("12340E-5", 123400000);
            ("1234E-4", 123400000);
            ("123.4E-3", 123400000);
            ("12.34E-2", 123400000);
            ("1.234E-1", 123400000);
            ("0.1234E0", 123400000);
            ("0.01234E1", 123400000);

            ("-12340E-5", -123400000);
            ("-1234E-4", -123400000);
            ("-123.4E-3", -123400000);
            ("-12.34E-2", -123400000);
            ("-1.234E-1", -123400000);
            ("-0.1234E0", -123400000);
            ("-0.01234E1", -123400000);

            ("1234567891234567890e-10", 123456789123456789);
            ("123456789123456789e-9", 123456789123456789);
            ("12345678912345678.9e-8", 123456789123456789);
            ("1234567891234567.89e-7", 123456789123456789);
            ("123456789123456.789e-6", 123456789123456789);
            ("12345678912345.6789e-5", 123456789123456789);
            ("1234567891234.56789e-4", 123456789123456789);
            ("123456789123.456789e-3", 123456789123456789);
            ("12345678912.3456789e-2", 123456789123456789);
            ("1234567891.23456789e-1", 123456789123456789);
            ("123456789.123456789e0", 123456789123456789);
            ("12345678.9123456789e1", 123456789123456789);
            ("1234567.89123456789e2", 123456789123456789);
            ("123456.789123456789e3", 123456789123456789);
            ("12345.6789123456789e4", 123456789123456789);
            ("1234.56789123456789e5", 123456789123456789);
            ("123.456789123456789e6", 123456789123456789);
            ("12.3456789123456789e7", 123456789123456789);
            ("1.23456789123456789e8", 123456789123456789);
            ("0.123456789123456789e9", 123456789123456789);

            ("92233720368547758070e-10", 9223372036854775807);
            ("9223372036854775807e-9", 9223372036854775807);
            ("922337203685477580.7e-8", 9223372036854775807);
            ("92233720368547758.07e-7", 9223372036854775807);
            ("9223372036854775.807e-6", 9223372036854775807);
            ("922337203685477.5807e-5", 9223372036854775807);
            ("92233720368547.75807e-4", 9223372036854775807);
            ("9223372036854.775807e-3", 9223372036854775807);
            ("922337203685.4775807e-2", 9223372036854775807);
            ("92233720368.54775807e-1", 9223372036854775807);
            ("9223372036.854775807e0", 9223372036854775807);
            ("922337203.6854775807e1", 9223372036854775807);
            ("92233720.36854775807e2", 9223372036854775807);
            ("9223372.036854775807e3", 9223372036854775807);
            ("922337.2036854775807e4", 9223372036854775807);
            ("92233.72036854775807e5", 9223372036854775807);
            ("9223.372036854775807e6", 9223372036854775807);
            ("922.3372036854775807e7", 9223372036854775807);
            ("92.23372036854775807e8", 9223372036854775807);
            ("9.223372036854775807e9", 9223372036854775807);
            ("0.9223372036854775807e10", 9223372036854775807);
            ("0.09223372036854775807e11", 9223372036854775807);

            ("-922337203685477580800.0e-11", -9223372036854775808);
            ("-92233720368547758080.0e-10", -9223372036854775808);
            ("-9223372036854775808.0e-9", -9223372036854775808);
            ("-922337203685477580.8e-8", -9223372036854775808);
            ("-92233720368547758.08e-7", -9223372036854775808);
            ("-9223372036854775.808e-6", -9223372036854775808);
            ("-922337203685477.5808e-5", -9223372036854775808);
            ("-92233720368547.75808e-4", -9223372036854775808);
            ("-9223372036854.775808e-3", -9223372036854775808);
            ("-922337203685.4775808e-2", -9223372036854775808);
            ("-92233720368.54775808e-1", -9223372036854775808);
            ("-9223372036.854775808e0", -9223372036854775808);
            ("-922337203.6854775808e1", -9223372036854775808);
            ("-92233720.36854775808e2", -9223372036854775808);
            ("-9223372.036854775808e3", -9223372036854775808);
            ("-922337.2036854775808e4", -9223372036854775808);
            ("-92233.72036854775808e5", -9223372036854775808);
            ("-9223.372036854775808e6", -9223372036854775808);
            ("-922.3372036854775808e7", -9223372036854775808);
            ("-92.23372036854775808e8", -9223372036854775808);
            ("-9.223372036854775808e9", -9223372036854775808);
            ("-00.9223372036854775808e10", -9223372036854775808);
            ("-000.09223372036854775808e11", -9223372036854775808);

            ("10e-1", 1000000000);
            ("10000000000e-10", 1000000000);
            ("10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E-100", 1000000000);
            ("10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E-100", 1000000000);

            ("0.1e1", 1000000000);
            ("0.0000000001e10", 1000000000);
            ("0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E100", 1000000000);
            ("000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E100", 1000000000);

            ("-10e-1", -1000000000);
            ("-10000000000e-10", -1000000000);
            ("-10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E-100", -1000000000);
            ("-10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E-100", -1000000000);

            ("-0.1e1", -1000000000);
            ("-0.0000000001e10", -1000000000);
            ("-0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E100", -1000000000);
            ("-000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E100", -1000000000);
        },
        fp128 {
            ("1", 1000000000000000000);
            ("1.1", 1100000000000000000);
            ("1.02", 1020000000000000000);
            ("-1.02", -1020000000000000000);
            ("+1.02", 1020000000000000000);
            ("0.1234", 123400000000000000);
            ("-0.1234", -123400000000000000);
            ("123456789.123456789", 123456789123456789000000000);
            ("9223372036.854775807", 9223372036854775807000000000);
            ("-9223372036.854775808", -9223372036854775808000000000);
            ("170141183460469231731.687303715884105727",
             170141183460469231731687303715884105727);
            ("-170141183460469231731.687303715884105728",
             -170141183460469231731687303715884105728);

             ("1e0", 1000000000000000000);
            ("1E0", 1000000000000000000);
            ("+1E+0", 1000000000000000000);
            ("-1E+0", -1000000000000000000);
            ("1E-0", 1000000000000000000);
            ("-1E-0", -1000000000000000000);

            ("110E-2", 1100000000000000000);
            ("11E-1", 1100000000000000000);
            ("1.1E0", 1100000000000000000);
            ("0.11E1", 1100000000000000000);
            ("0.011E+2", 1100000000000000000);

            ("-110E-2", -1100000000000000000);
            ("-11E-1", -1100000000000000000);
            ("-1.1E0", -1100000000000000000);
            ("-0.11E1", -1100000000000000000);
            ("-0.011E+2", -1100000000000000000);

            ("1020e-3", 1020000000000000000);
            ("102e-2", 1020000000000000000);
            ("10.2e-1", 1020000000000000000);
            ("1.02e0", 1020000000000000000);
            ("0.102e1", 1020000000000000000);
            ("0.0102e2", 1020000000000000000);

            ("-1020e-3", -1020000000000000000);
            ("-102e-2", -1020000000000000000);
            ("-10.2e-1", -1020000000000000000);
            ("-1.02e0", -1020000000000000000);
            ("-0.102e1", -1020000000000000000);
            ("-0.0102e2", -1020000000000000000);

            ("12340E-5", 123400000000000000);
            ("1234E-4", 123400000000000000);
            ("123.4E-3", 123400000000000000);
            ("12.34E-2", 123400000000000000);
            ("1.234E-1", 123400000000000000);
            ("0.1234E0", 123400000000000000);
            ("0.01234E1", 123400000000000000);

            ("-12340E-5", -123400000000000000);
            ("-1234E-4", -123400000000000000);
            ("-123.4E-3", -123400000000000000);
            ("-12.34E-2", -123400000000000000);
            ("-1.234E-1", -123400000000000000);
            ("-0.1234E0", -123400000000000000);
            ("-0.01234E1", -123400000000000000);

            ("1234567891234567890e-10", 123456789123456789000000000);
            ("123456789123456789e-9", 123456789123456789000000000);
            ("12345678912345678.9e-8", 123456789123456789000000000);
            ("1234567891234567.89e-7", 123456789123456789000000000);
            ("123456789123456.789e-6", 123456789123456789000000000);
            ("12345678912345.6789e-5", 123456789123456789000000000);
            ("1234567891234.56789e-4", 123456789123456789000000000);
            ("123456789123.456789e-3", 123456789123456789000000000);
            ("12345678912.3456789e-2", 123456789123456789000000000);
            ("1234567891.23456789e-1", 123456789123456789000000000);
            ("123456789.123456789e0", 123456789123456789000000000);
            ("12345678.9123456789e1", 123456789123456789000000000);
            ("1234567.89123456789e2", 123456789123456789000000000);
            ("123456.789123456789e3", 123456789123456789000000000);
            ("12345.6789123456789e4", 123456789123456789000000000);
            ("1234.56789123456789e5", 123456789123456789000000000);
            ("123.456789123456789e6", 123456789123456789000000000);
            ("12.3456789123456789e7", 123456789123456789000000000);
            ("1.23456789123456789e8", 123456789123456789000000000);
            ("0.123456789123456789e9", 123456789123456789000000000);

            ("92233720368547758070e-10", 9223372036854775807000000000);
            ("9223372036854775807e-9", 9223372036854775807000000000);
            ("922337203685477580.7e-8", 9223372036854775807000000000);
            ("92233720368547758.07e-7", 9223372036854775807000000000);
            ("9223372036854775.807e-6", 9223372036854775807000000000);
            ("922337203685477.5807e-5", 9223372036854775807000000000);
            ("92233720368547.75807e-4", 9223372036854775807000000000);
            ("9223372036854.775807e-3", 9223372036854775807000000000);
            ("922337203685.4775807e-2", 9223372036854775807000000000);
            ("92233720368.54775807e-1", 9223372036854775807000000000);
            ("9223372036.854775807e0", 9223372036854775807000000000);
            ("922337203.6854775807e1", 9223372036854775807000000000);
            ("92233720.36854775807e2", 9223372036854775807000000000);
            ("9223372.036854775807e3", 9223372036854775807000000000);
            ("922337.2036854775807e4", 9223372036854775807000000000);
            ("92233.72036854775807e5", 9223372036854775807000000000);
            ("9223.372036854775807e6", 9223372036854775807000000000);
            ("922.3372036854775807e7", 9223372036854775807000000000);
            ("92.23372036854775807e8", 9223372036854775807000000000);
            ("9.223372036854775807e9", 9223372036854775807000000000);
            ("0.9223372036854775807e10", 9223372036854775807000000000);
            ("0.09223372036854775807e11", 9223372036854775807000000000);

            ("-922337203685477580800.0e-11", -9223372036854775808000000000);
            ("-92233720368547758080.0e-10", -9223372036854775808000000000);
            ("-9223372036854775808.0e-9", -9223372036854775808000000000);
            ("-922337203685477580.8e-8", -9223372036854775808000000000);
            ("-92233720368547758.08e-7", -9223372036854775808000000000);
            ("-9223372036854775.808e-6", -9223372036854775808000000000);
            ("-922337203685477.5808e-5", -9223372036854775808000000000);
            ("-92233720368547.75808e-4", -9223372036854775808000000000);
            ("-9223372036854.775808e-3", -9223372036854775808000000000);
            ("-922337203685.4775808e-2", -9223372036854775808000000000);
            ("-92233720368.54775808e-1", -9223372036854775808000000000);
            ("-9223372036.854775808e0", -9223372036854775808000000000);
            ("-922337203.6854775808e1", -9223372036854775808000000000);
            ("-92233720.36854775808e2", -9223372036854775808000000000);
            ("-9223372.036854775808e3", -9223372036854775808000000000);
            ("-922337.2036854775808e4", -9223372036854775808000000000);
            ("-92233.72036854775808e5", -9223372036854775808000000000);
            ("-9223.372036854775808e6", -9223372036854775808000000000);
            ("-922.3372036854775808e7", -9223372036854775808000000000);
            ("-92.23372036854775808e8", -9223372036854775808000000000);
            ("-9.223372036854775808e9", -9223372036854775808000000000);
            ("-00.9223372036854775808e10", -9223372036854775808000000000);
            ("-000.09223372036854775808e11", -9223372036854775808000000000);

            ("170141183460469231731687303715884105727000e-21", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371588410572700e-20", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037158841057270e-19", 170141183460469231731687303715884105727);
            ("170141183460469231731687303715884105727e-18", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371588410572.7e-17", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037158841057.27e-16", 170141183460469231731687303715884105727);
            ("170141183460469231731687303715884105.727e-15", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371588410.5727e-14", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037158841.05727e-13", 170141183460469231731687303715884105727);
            ("170141183460469231731687303715884.105727e-12", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371588.4105727e-11", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037158.84105727e-10", 170141183460469231731687303715884105727);
            ("170141183460469231731687303715.884105727e-9", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371.5884105727e-8", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037.15884105727e-7", 170141183460469231731687303715884105727);
            ("170141183460469231731687303.715884105727e-6", 170141183460469231731687303715884105727);
            ("17014118346046923173168730.3715884105727e-5", 170141183460469231731687303715884105727);
            ("1701411834604692317316873.03715884105727e-4", 170141183460469231731687303715884105727);
            ("170141183460469231731687.303715884105727e-3", 170141183460469231731687303715884105727);
            ("17014118346046923173168.7303715884105727e-2", 170141183460469231731687303715884105727);
            ("1701411834604692317316.87303715884105727e-1", 170141183460469231731687303715884105727);
            ("170141183460469231731.687303715884105727e0", 170141183460469231731687303715884105727);
            ("17014118346046923173.1687303715884105727e1", 170141183460469231731687303715884105727);
            ("1701411834604692317.31687303715884105727e2", 170141183460469231731687303715884105727);
            ("170141183460469231.731687303715884105727e3", 170141183460469231731687303715884105727);
            ("17014118346046923.1731687303715884105727e4", 170141183460469231731687303715884105727);
            ("1701411834604692.31731687303715884105727e5", 170141183460469231731687303715884105727);
            ("170141183460469.231731687303715884105727e6", 170141183460469231731687303715884105727);
            ("17014118346046.9231731687303715884105727e7", 170141183460469231731687303715884105727);
            ("1701411834604.69231731687303715884105727e8", 170141183460469231731687303715884105727);
            ("170141183460.469231731687303715884105727e9", 170141183460469231731687303715884105727);
            ("17014118346.0469231731687303715884105727e10", 170141183460469231731687303715884105727);
            ("1701411834.60469231731687303715884105727e11", 170141183460469231731687303715884105727);
            ("170141183.460469231731687303715884105727e12", 170141183460469231731687303715884105727);
            ("17014118.3460469231731687303715884105727e13", 170141183460469231731687303715884105727);
            ("1701411.83460469231731687303715884105727e14", 170141183460469231731687303715884105727);
            ("170141.183460469231731687303715884105727e15", 170141183460469231731687303715884105727);
            ("17014.1183460469231731687303715884105727e16", 170141183460469231731687303715884105727);
            ("1701.41183460469231731687303715884105727e17", 170141183460469231731687303715884105727);
            ("170.141183460469231731687303715884105727e18", 170141183460469231731687303715884105727);
            ("17.0141183460469231731687303715884105727e19", 170141183460469231731687303715884105727);
            ("1.70141183460469231731687303715884105727e20", 170141183460469231731687303715884105727);
            ("0.170141183460469231731687303715884105727e21", 170141183460469231731687303715884105727);
            ("0.0170141183460469231731687303715884105727e22", 170141183460469231731687303715884105727);
            ("0.00170141183460469231731687303715884105727e23", 170141183460469231731687303715884105727);
            ("0.000170141183460469231731687303715884105727e24", 170141183460469231731687303715884105727);

            ("-170141183460469231731687303715884105728000e-21", -170141183460469231731687303715884105728);
            ("-17014118346046923173168730371588410572800e-20", -170141183460469231731687303715884105728);
            ("-1701411834604692317316873037158841057280e-19", -170141183460469231731687303715884105728);
            ("-170141183460469231731687303715884105728e-18", -170141183460469231731687303715884105728);
            ("-17014118346046923173168730371588410572.8e-17", -170141183460469231731687303715884105728);
            ("-1701411834604692317316873037158841057.28e-16", -170141183460469231731687303715884105728);
            ("-170141183460469231731687303715884105.728e-15", -170141183460469231731687303715884105728);
            ("-17014118346046923173168730371588410.5728e-14", -170141183460469231731687303715884105728);
            ("-1701411834604692317316873037158841.05728e-13", -170141183460469231731687303715884105728);
            ("-170141183460469231731687303715884.105728e-12", -170141183460469231731687303715884105728);
            ("-17014118346046923173168730371588.4105728e-11", -170141183460469231731687303715884105728);
            ("-1701411834604692317316873037158.84105728e-10", -170141183460469231731687303715884105728);
            ("-170141183460469231731687303715.884105728e-9", -170141183460469231731687303715884105728);
            ("-17014118346046923173168730371.5884105728e-8", -170141183460469231731687303715884105728);
            ("-1701411834604692317316873037.15884105728e-7", -170141183460469231731687303715884105728);
            ("-170141183460469231731687303.715884105728e-6", -170141183460469231731687303715884105728);
            ("-17014118346046923173168730.3715884105728e-5", -170141183460469231731687303715884105728);
            ("-1701411834604692317316873.03715884105728e-4", -170141183460469231731687303715884105728);
            ("-170141183460469231731687.303715884105728e-3", -170141183460469231731687303715884105728);
            ("-17014118346046923173168.7303715884105728e-2", -170141183460469231731687303715884105728);
            ("-1701411834604692317316.87303715884105728e-1", -170141183460469231731687303715884105728);
            ("-170141183460469231731.687303715884105728e0", -170141183460469231731687303715884105728);
            ("-17014118346046923173.1687303715884105728e1", -170141183460469231731687303715884105728);
            ("-1701411834604692317.31687303715884105728e2", -170141183460469231731687303715884105728);
            ("-170141183460469231.731687303715884105728e3", -170141183460469231731687303715884105728);
            ("-17014118346046923.1731687303715884105728e4", -170141183460469231731687303715884105728);
            ("-1701411834604692.31731687303715884105728e5", -170141183460469231731687303715884105728);
            ("-170141183460469.231731687303715884105728e6", -170141183460469231731687303715884105728);
            ("-17014118346046.9231731687303715884105728e7", -170141183460469231731687303715884105728);
            ("-1701411834604.69231731687303715884105728e8", -170141183460469231731687303715884105728);
            ("-170141183460.469231731687303715884105728e9", -170141183460469231731687303715884105728);
            ("-17014118346.0469231731687303715884105728e10", -170141183460469231731687303715884105728);
            ("-1701411834.60469231731687303715884105728e11", -170141183460469231731687303715884105728);
            ("-170141183.460469231731687303715884105728e12", -170141183460469231731687303715884105728);
            ("-17014118.3460469231731687303715884105728e13", -170141183460469231731687303715884105728);
            ("-1701411.83460469231731687303715884105728e14", -170141183460469231731687303715884105728);
            ("-170141.183460469231731687303715884105728e15", -170141183460469231731687303715884105728);
            ("-17014.1183460469231731687303715884105728e16", -170141183460469231731687303715884105728);
            ("-1701.41183460469231731687303715884105728e17", -170141183460469231731687303715884105728);
            ("-170.141183460469231731687303715884105728e18", -170141183460469231731687303715884105728);
            ("-17.0141183460469231731687303715884105728e19", -170141183460469231731687303715884105728);
            ("-1.70141183460469231731687303715884105728e20", -170141183460469231731687303715884105728);
            ("-0.170141183460469231731687303715884105728e21", -170141183460469231731687303715884105728);
            ("-0.0170141183460469231731687303715884105728e22", -170141183460469231731687303715884105728);
            ("-0.00170141183460469231731687303715884105728e23", -170141183460469231731687303715884105728);
            ("-0.000170141183460469231731687303715884105728e24", -170141183460469231731687303715884105728);

            ("10e-1", 1000000000000000000);
            ("10000000000e-10", 1000000000000000000);
            ("10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E-100", 1000000000000000000);
            ("10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E-100", 1000000000000000000);

            ("0.1e1", 1000000000000000000);
            ("0.0000000001e10", 1000000000000000000);
            ("0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E100", 1000000000000000000);
            ("000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E100", 1000000000000000000);

            ("-10e-1", -1000000000000000000);
            ("-10000000000e-10", -1000000000000000000);
            ("-10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E-100", -1000000000000000000);
            ("-10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E-100", -1000000000000000000);

            ("-0.1e1", -1000000000000000000);
            ("-0.0000000001e10", -1000000000000000000);
            ("-0.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E100", -1000000000000000000);
            ("-000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E100", -1000000000000000000);
        },
    };
    Ok(())
}

#[test]
#[allow(overflowing_literals)]
fn from_good_str_inexact() -> Result<()> {
    test_fixed_point! {
        case (input: &str, expected: Layout) => {
            fn check(input: &str, expected: Layout) -> TestCaseResult {
                let expected = FixedPoint::from_bits(expected);
                let inexact: FixedPoint = input.parse()?;
                assert_eq!(inexact, expected);

                // An exact version must fail.
                let exact = FixedPoint::from_str_exact(input);
                assert!(exact.is_err(), "exact must not parse '{}'", input);

                #[cfg(feature = "serde")]
                assert_eq!(serde_json::from_str::<FixedPoint>(&format!("\"{}\"", input))?, expected);
                #[cfg(feature = "serde")]
                assert_eq!(serde_json::from_str::<FixedPoint>(&format!("\"{}\"", inexact))?, expected);
                Ok(())
            }

            check(input, expected)?;
            check(&format!("-{}", input), -expected)?;
        },
        fp64 {
            ("13.0000000000000000001", 13000000000);
            ("13.0000000000000000005", 13000000000);
            ("13.0000000001", 13000000000);
            ("13.0000000005", 13000000001);
            ("13.0000000009", 13000000001);
            ("13.1000000001", 13100000000);
            ("13.1000000005", 13100000001);
            ("13.1000000009", 13100000001);
            ("13.9999999999999999999999999999999999999999999999999999999999999", 14000000000);
            ("9223372036.8547758071", 9223372036854775807);

            ("13000000000000000000100e-21", 13000000000);
            ("1300000000000000000010e-20", 13000000000);
            ("130000000000000000001e-19", 13000000000);
            ("13000000000000000000.1e-18", 13000000000);
            ("1300000000000000000.01e-17", 13000000000);
            ("130000000000000000.001e-16", 13000000000);
            ("13000000000000000.0001e-15", 13000000000);
            ("1300000000000000.00001e-14", 13000000000);
            ("130000000000000.000001e-13", 13000000000);
            ("13000000000000.0000001e-12", 13000000000);
            ("1300000000000.00000001e-11", 13000000000);
            ("130000000000.000000001e-10", 13000000000);
            ("13000000000.0000000001e-9", 13000000000);
            ("1300000000.00000000001e-8", 13000000000);
            ("130000000.000000000001e-7", 13000000000);
            ("13000000.0000000000001e-6", 13000000000);
            ("1300000.00000000000001e-5", 13000000000);
            ("130000.000000000000001e-4", 13000000000);
            ("13000.0000000000000001e-3", 13000000000);
            ("1300.00000000000000001e-2", 13000000000);
            ("130.000000000000000001e-1", 13000000000);
            ("13.0000000000000000001e0", 13000000000);
            ("1.30000000000000000001e1", 13000000000);
            ("0.130000000000000000001e2", 13000000000);
            ("0.0130000000000000000001e3", 13000000000);
            ("0.00130000000000000000001e4", 13000000000);
            ("0.000130000000000000000001e5", 13000000000);

            ("13000000000000000000500e-21", 13000000000);
            ("1300000000000000000050e-20", 13000000000);
            ("130000000000000000005e-19", 13000000000);
            ("13000000000000000000.5e-18", 13000000000);
            ("1300000000000000000.05e-17", 13000000000);
            ("130000000000000000.005e-16", 13000000000);
            ("13000000000000000.0005e-15", 13000000000);
            ("1300000000000000.00005e-14", 13000000000);
            ("130000000000000.000005e-13", 13000000000);
            ("13000000000000.0000005e-12", 13000000000);
            ("1300000000000.00000005e-11", 13000000000);
            ("130000000000.000000005e-10", 13000000000);
            ("13000000000.0000000005e-9", 13000000000);
            ("1300000000.00000000005e-8", 13000000000);
            ("130000000.000000000005e-7", 13000000000);
            ("13000000.0000000000005e-6", 13000000000);
            ("1300000.00000000000005e-5", 13000000000);
            ("130000.000000000000005e-4", 13000000000);
            ("13000.0000000000000005e-3", 13000000000);
            ("1300.00000000000000005e-2", 13000000000);
            ("130.000000000000000005e-1", 13000000000);
            ("13.0000000000000000005e0", 13000000000);
            ("1.30000000000000000005e1", 13000000000);
            ("0.130000000000000000005e2", 13000000000);
            ("0.0130000000000000000005e3", 13000000000);
            ("0.00130000000000000000005e4", 13000000000);
            ("0.000130000000000000000005e5", 13000000000);

            ("1300000000010e-11", 13000000000);
            ("130000000001e-10", 13000000000);
            ("13000000000.1e-9", 13000000000);
            ("1300000000.01e-8", 13000000000);
            ("130000000.001e-7", 13000000000);
            ("13000000.0001e-6", 13000000000);
            ("1300000.00001e-5", 13000000000);
            ("130000.000001e-4", 13000000000);
            ("13000.0000001e-3", 13000000000);
            ("1300.00000001e-2", 13000000000);
            ("130.000000001e-1", 13000000000);
            ("13.0000000001e0", 13000000000);
            ("1.30000000001e1", 13000000000);
            ("0.130000000001e2", 13000000000);
            ("0.0130000000001e3", 13000000000);

            ("1300000000050e-11", 13000000001);
            ("130000000005e-10", 13000000001);
            ("13000000000.5e-9", 13000000001);
            ("1300000000.05e-8", 13000000001);
            ("130000000.005e-7", 13000000001);
            ("13000000.0005e-6", 13000000001);
            ("1300000.00005e-5", 13000000001);
            ("130000.000005e-4", 13000000001);
            ("13000.0000005e-3", 13000000001);
            ("1300.00000005e-2", 13000000001);
            ("130.000000005e-1", 13000000001);
            ("13.0000000005e0", 13000000001);
            ("1.30000000005e1", 13000000001);
            ("0.130000000005e2", 13000000001);
            ("0.0130000000005e3", 13000000001);

            ("1300000000090e-11", 13000000001);
            ("130000000009e-10", 13000000001);
            ("13000000000.9e-9", 13000000001);
            ("1300000000.09e-8", 13000000001);
            ("130000000.009e-7", 13000000001);
            ("13000000.0009e-6", 13000000001);
            ("1300000.00009e-5", 13000000001);
            ("130000.000009e-4", 13000000001);
            ("13000.0000009e-3", 13000000001);
            ("1300.00000009e-2", 13000000001);
            ("130.000000009e-1", 13000000001);
            ("13.0000000009e0", 13000000001);
            ("1.30000000009e1", 13000000001);
            ("0.130000000009e2", 13000000001);
            ("0.0130000000009e3", 13000000001);

            ("1310000000010e-11", 13100000000);
            ("131000000001e-10", 13100000000);
            ("13100000000.1e-9", 13100000000);
            ("1310000000.01e-8", 13100000000);
            ("131000000.001e-7", 13100000000);
            ("13100000.0001e-6", 13100000000);
            ("1310000.00001e-5", 13100000000);
            ("131000.000001e-4", 13100000000);
            ("13100.0000001e-3", 13100000000);
            ("1310.00000001e-2", 13100000000);
            ("131.000000001e-1", 13100000000);
            ("13.1000000001e0", 13100000000);
            ("1.31000000001e1", 13100000000);
            ("0.131000000001e2", 13100000000);
            ("0.0131000000001e3", 13100000000);

            ("1310000000050e-11", 13100000001);
            ("131000000005e-10", 13100000001);
            ("13100000000.5e-9", 13100000001);
            ("1310000000.05e-8", 13100000001);
            ("131000000.005e-7", 13100000001);
            ("13100000.0005e-6", 13100000001);
            ("1310000.00005e-5", 13100000001);
            ("131000.000005e-4", 13100000001);
            ("13100.0000005e-3", 13100000001);
            ("1310.00000005e-2", 13100000001);
            ("131.000000005e-1", 13100000001);
            ("13.1000000005e0", 13100000001);
            ("1.31000000005e1", 13100000001);
            ("0.131000000005e2", 13100000001);
            ("0.0131000000005e3", 13100000001);

            ("1310000000090e-11", 13100000001);
            ("131000000009e-10", 13100000001);
            ("13100000000.9e-9", 13100000001);
            ("1310000000.09e-8", 13100000001);
            ("131000000.009e-7", 13100000001);
            ("13100000.0009e-6", 13100000001);
            ("1310000.00009e-5", 13100000001);
            ("131000.000009e-4", 13100000001);
            ("13100.0000009e-3", 13100000001);
            ("1310.00000009e-2", 13100000001);
            ("131.000000009e-1", 13100000001);
            ("13.1000000009e0", 13100000001);
            ("1.31000000009e1", 13100000001);
            ("0.131000000009e2", 13100000001);
            ("0.0131000000009e3", 13100000001);

            ("13999999999999999999999999999999999999999999999999999999999999900e-63", 14000000000);
            ("1399999999999999999999999999999999999999999999999999999999999990e-62", 14000000000);
            ("139999999999999999999999999999999999999999999999999999999999999e-61", 14000000000);
            ("13999999999999999999999999999999999999999999999999999999999999.9e-60", 14000000000);
            ("1399999999999999999999999999999999999999999999999999999999999.99e-59", 14000000000);
            ("139999999999999999999999999999999999999999999999999999999999.999e-58", 14000000000);
            ("13999999999999999999999999999999999999999999999999999999999.9999e-57", 14000000000);
            ("1399999999999999999999999999999999999999999999999999999999.99999e-56", 14000000000);
            ("139999999999999999999999999999999999999999999999999999999.999999e-55", 14000000000);
            ("13999999999999999999999999999999999999999999999999999999.9999999e-54", 14000000000);
            ("1399999999999999999999999999999999999999999999999999999.99999999e-53", 14000000000);
            ("139999999999999999999999999999999999999999999999999999.999999999e-52", 14000000000);
            ("13999999999999999999999999999999999999999999999999999.9999999999e-51", 14000000000);
            ("1399999999999999999999999999999999999999999999999999.99999999999e-50", 14000000000);
            ("139999999999999999999999999999999999999999999999999.999999999999e-49", 14000000000);
            ("13999999999999999999999999999999999999999999999999.9999999999999e-48", 14000000000);
            ("1399999999999999999999999999999999999999999999999.99999999999999e-47", 14000000000);
            ("139999999999999999999999999999999999999999999999.999999999999999e-46", 14000000000);
            ("13999999999999999999999999999999999999999999999.9999999999999999e-45", 14000000000);
            ("1399999999999999999999999999999999999999999999.99999999999999999e-44", 14000000000);
            ("139999999999999999999999999999999999999999999.999999999999999999e-43", 14000000000);
            ("13999999999999999999999999999999999999999999.9999999999999999999e-42", 14000000000);
            ("1399999999999999999999999999999999999999999.99999999999999999999e-41", 14000000000);
            ("139999999999999999999999999999999999999999.999999999999999999999e-40", 14000000000);
            ("13999999999999999999999999999999999999999.9999999999999999999999e-39", 14000000000);
            ("1399999999999999999999999999999999999999.99999999999999999999999e-38", 14000000000);
            ("139999999999999999999999999999999999999.999999999999999999999999e-37", 14000000000);
            ("13999999999999999999999999999999999999.9999999999999999999999999e-36", 14000000000);
            ("1399999999999999999999999999999999999.99999999999999999999999999e-35", 14000000000);
            ("139999999999999999999999999999999999.999999999999999999999999999e-34", 14000000000);
            ("13999999999999999999999999999999999.9999999999999999999999999999e-33", 14000000000);
            ("1399999999999999999999999999999999.99999999999999999999999999999e-32", 14000000000);
            ("139999999999999999999999999999999.999999999999999999999999999999e-31", 14000000000);
            ("13999999999999999999999999999999.9999999999999999999999999999999e-30", 14000000000);
            ("1399999999999999999999999999999.99999999999999999999999999999999e-29", 14000000000);
            ("139999999999999999999999999999.999999999999999999999999999999999e-28", 14000000000);
            ("13999999999999999999999999999.9999999999999999999999999999999999e-27", 14000000000);
            ("1399999999999999999999999999.99999999999999999999999999999999999e-26", 14000000000);
            ("139999999999999999999999999.999999999999999999999999999999999999e-25", 14000000000);
            ("13999999999999999999999999.9999999999999999999999999999999999999e-24", 14000000000);
            ("1399999999999999999999999.99999999999999999999999999999999999999e-23", 14000000000);
            ("139999999999999999999999.999999999999999999999999999999999999999e-22", 14000000000);
            ("13999999999999999999999.9999999999999999999999999999999999999999e-21", 14000000000);
            ("1399999999999999999999.99999999999999999999999999999999999999999e-20", 14000000000);
            ("139999999999999999999.999999999999999999999999999999999999999999e-19", 14000000000);
            ("13999999999999999999.9999999999999999999999999999999999999999999e-18", 14000000000);
            ("1399999999999999999.99999999999999999999999999999999999999999999e-17", 14000000000);
            ("139999999999999999.999999999999999999999999999999999999999999999e-16", 14000000000);
            ("13999999999999999.9999999999999999999999999999999999999999999999e-15", 14000000000);
            ("1399999999999999.99999999999999999999999999999999999999999999999e-14", 14000000000);
            ("139999999999999.999999999999999999999999999999999999999999999999e-13", 14000000000);
            ("13999999999999.9999999999999999999999999999999999999999999999999e-12", 14000000000);
            ("1399999999999.99999999999999999999999999999999999999999999999999e-11", 14000000000);
            ("139999999999.999999999999999999999999999999999999999999999999999e-10", 14000000000);
            ("13999999999.9999999999999999999999999999999999999999999999999999e-9", 14000000000);
            ("1399999999.99999999999999999999999999999999999999999999999999999e-8", 14000000000);
            ("139999999.999999999999999999999999999999999999999999999999999999e-7", 14000000000);
            ("13999999.9999999999999999999999999999999999999999999999999999999e-6", 14000000000);
            ("1399999.99999999999999999999999999999999999999999999999999999999e-5", 14000000000);
            ("139999.999999999999999999999999999999999999999999999999999999999e-4", 14000000000);
            ("13999.9999999999999999999999999999999999999999999999999999999999e-3", 14000000000);
            ("1399.99999999999999999999999999999999999999999999999999999999999e-2", 14000000000);
            ("139.999999999999999999999999999999999999999999999999999999999999e-1", 14000000000);
            ("13.9999999999999999999999999999999999999999999999999999999999999e0", 14000000000);
            ("1.39999999999999999999999999999999999999999999999999999999999999e1", 14000000000);
            ("0.139999999999999999999999999999999999999999999999999999999999999e2", 14000000000);
            ("0.0139999999999999999999999999999999999999999999999999999999999999e3", 14000000000);

            ("9223372036854775807100e-12", 9223372036854775807);
            ("922337203685477580710e-11", 9223372036854775807);
            ("92233720368547758071e-10", 9223372036854775807);
            ("9223372036854775807.1e-9", 9223372036854775807);
            ("922337203685477580.71e-8", 9223372036854775807);
            ("92233720368547758.071e-7", 9223372036854775807);
            ("9223372036854775.8071e-6", 9223372036854775807);
            ("922337203685477.58071e-5", 9223372036854775807);
            ("92233720368547.758071e-4", 9223372036854775807);
            ("9223372036854.7758071e-3", 9223372036854775807);
            ("922337203685.47758071e-2", 9223372036854775807);
            ("92233720368.547758071e-1", 9223372036854775807);
            ("9223372036.8547758071e0", 9223372036854775807);
            ("922337203.68547758071e1", 9223372036854775807);
            ("92233720.368547758071e2", 9223372036854775807);
            ("9223372.0368547758071e3", 9223372036854775807);
            ("922337.20368547758071e4", 9223372036854775807);
            ("92233.720368547758071e5", 9223372036854775807);
            ("9223.3720368547758071e6", 9223372036854775807);
            ("922.33720368547758071e7", 9223372036854775807);
            ("92.233720368547758071e8", 9223372036854775807);
            ("9.2233720368547758071e9", 9223372036854775807);
            ("0.92233720368547758071e10", 9223372036854775807);
            ("0.092233720368547758071e11", 9223372036854775807);
            // Negative cases are also checked.
        },
        fp128 {
            ("13.0000000000000000001", 13000000000000000000);
            ("13.0000000000000000005", 13000000000000000001);
            ("13.0000000000000000009", 13000000000000000001);
            ("13.9999999999999999999999999999999999999999999999999999999999999",
             14000000000000000000);
            ("170141183460469231731.6873037158841057271",
             170141183460469231731687303715884105727);

            ("13000000000000000000100e-21", 13000000000000000000);
            ("1300000000000000000010e-20", 13000000000000000000);
            ("130000000000000000001e-19", 13000000000000000000);
            ("13000000000000000000.1e-18", 13000000000000000000);
            ("1300000000000000000.01e-17", 13000000000000000000);
            ("130000000000000000.001e-16", 13000000000000000000);
            ("13000000000000000.0001e-15", 13000000000000000000);
            ("1300000000000000.00001e-14", 13000000000000000000);
            ("130000000000000.000001e-13", 13000000000000000000);
            ("13000000000000.0000001e-12", 13000000000000000000);
            ("1300000000000.00000001e-11", 13000000000000000000);
            ("130000000000.000000001e-10", 13000000000000000000);
            ("13000000000.0000000001e-9", 13000000000000000000);
            ("1300000000.00000000001e-8", 13000000000000000000);
            ("130000000.000000000001e-7", 13000000000000000000);
            ("13000000.0000000000001e-6", 13000000000000000000);
            ("1300000.00000000000001e-5", 13000000000000000000);
            ("130000.000000000000001e-4", 13000000000000000000);
            ("13000.0000000000000001e-3", 13000000000000000000);
            ("1300.00000000000000001e-2", 13000000000000000000);
            ("130.000000000000000001e-1", 13000000000000000000);
            ("13.0000000000000000001e0", 13000000000000000000);
            ("1.30000000000000000001e1", 13000000000000000000);
            ("0.130000000000000000001e2", 13000000000000000000);
            ("0.0130000000000000000001e3", 13000000000000000000);
            ("0.00130000000000000000001e4", 13000000000000000000);
            ("0.000130000000000000000001e5", 13000000000000000000);

            ("13000000000000000000500e-21", 13000000000000000001);
            ("1300000000000000000050e-20", 13000000000000000001);
            ("130000000000000000005e-19", 13000000000000000001);
            ("13000000000000000000.5e-18", 13000000000000000001);
            ("1300000000000000000.05e-17", 13000000000000000001);
            ("130000000000000000.005e-16", 13000000000000000001);
            ("13000000000000000.0005e-15", 13000000000000000001);
            ("1300000000000000.00005e-14", 13000000000000000001);
            ("130000000000000.000005e-13", 13000000000000000001);
            ("13000000000000.0000005e-12", 13000000000000000001);
            ("1300000000000.00000005e-11", 13000000000000000001);
            ("130000000000.000000005e-10", 13000000000000000001);
            ("13000000000.0000000005e-9", 13000000000000000001);
            ("1300000000.00000000005e-8", 13000000000000000001);
            ("130000000.000000000005e-7", 13000000000000000001);
            ("13000000.0000000000005e-6", 13000000000000000001);
            ("1300000.00000000000005e-5", 13000000000000000001);
            ("130000.000000000000005e-4", 13000000000000000001);
            ("13000.0000000000000005e-3", 13000000000000000001);
            ("1300.00000000000000005e-2", 13000000000000000001);
            ("130.000000000000000005e-1", 13000000000000000001);
            ("13.0000000000000000005e0", 13000000000000000001);
            ("1.30000000000000000005e1", 13000000000000000001);
            ("0.130000000000000000005e2", 13000000000000000001);
            ("0.0130000000000000000005e3", 13000000000000000001);
            ("0.00130000000000000000005e4", 13000000000000000001);
            ("0.000130000000000000000005e5", 13000000000000000001);

            ("13000000000000000000900e-21", 13000000000000000001);
            ("1300000000000000000090e-20", 13000000000000000001);
            ("130000000000000000009e-19", 13000000000000000001);
            ("13000000000000000000.9e-18", 13000000000000000001);
            ("1300000000000000000.09e-17", 13000000000000000001);
            ("130000000000000000.009e-16", 13000000000000000001);
            ("13000000000000000.0009e-15", 13000000000000000001);
            ("1300000000000000.00009e-14", 13000000000000000001);
            ("130000000000000.000009e-13", 13000000000000000001);
            ("13000000000000.0000009e-12", 13000000000000000001);
            ("1300000000000.00000009e-11", 13000000000000000001);
            ("130000000000.000000009e-10", 13000000000000000001);
            ("13000000000.0000000009e-9", 13000000000000000001);
            ("1300000000.00000000009e-8", 13000000000000000001);
            ("130000000.000000000009e-7", 13000000000000000001);
            ("13000000.0000000000009e-6", 13000000000000000001);
            ("1300000.00000000000009e-5", 13000000000000000001);
            ("130000.000000000000009e-4", 13000000000000000001);
            ("13000.0000000000000009e-3", 13000000000000000001);
            ("1300.00000000000000009e-2", 13000000000000000001);
            ("130.000000000000000009e-1", 13000000000000000001);
            ("13.0000000000000000009e0", 13000000000000000001);
            ("1.30000000000000000009e1", 13000000000000000001);
            ("0.130000000000000000009e2", 13000000000000000001);
            ("0.0130000000000000000009e3", 13000000000000000001);
            ("0.00130000000000000000009e4", 13000000000000000001);
            ("0.000130000000000000000009e5", 13000000000000000001);

            ("13999999999999999999999999999999999999999999999999999999999999900e-63", 14000000000000000000);
            ("1399999999999999999999999999999999999999999999999999999999999990e-62", 14000000000000000000);
            ("139999999999999999999999999999999999999999999999999999999999999e-61", 14000000000000000000);
            ("13999999999999999999999999999999999999999999999999999999999999.9e-60", 14000000000000000000);
            ("1399999999999999999999999999999999999999999999999999999999999.99e-59", 14000000000000000000);
            ("139999999999999999999999999999999999999999999999999999999999.999e-58", 14000000000000000000);
            ("13999999999999999999999999999999999999999999999999999999999.9999e-57", 14000000000000000000);
            ("1399999999999999999999999999999999999999999999999999999999.99999e-56", 14000000000000000000);
            ("139999999999999999999999999999999999999999999999999999999.999999e-55", 14000000000000000000);
            ("13999999999999999999999999999999999999999999999999999999.9999999e-54", 14000000000000000000);
            ("1399999999999999999999999999999999999999999999999999999.99999999e-53", 14000000000000000000);
            ("139999999999999999999999999999999999999999999999999999.999999999e-52", 14000000000000000000);
            ("13999999999999999999999999999999999999999999999999999.9999999999e-51", 14000000000000000000);
            ("1399999999999999999999999999999999999999999999999999.99999999999e-50", 14000000000000000000);
            ("139999999999999999999999999999999999999999999999999.999999999999e-49", 14000000000000000000);
            ("13999999999999999999999999999999999999999999999999.9999999999999e-48", 14000000000000000000);
            ("1399999999999999999999999999999999999999999999999.99999999999999e-47", 14000000000000000000);
            ("139999999999999999999999999999999999999999999999.999999999999999e-46", 14000000000000000000);
            ("13999999999999999999999999999999999999999999999.9999999999999999e-45", 14000000000000000000);
            ("1399999999999999999999999999999999999999999999.99999999999999999e-44", 14000000000000000000);
            ("139999999999999999999999999999999999999999999.999999999999999999e-43", 14000000000000000000);
            ("13999999999999999999999999999999999999999999.9999999999999999999e-42", 14000000000000000000);
            ("1399999999999999999999999999999999999999999.99999999999999999999e-41", 14000000000000000000);
            ("139999999999999999999999999999999999999999.999999999999999999999e-40", 14000000000000000000);
            ("13999999999999999999999999999999999999999.9999999999999999999999e-39", 14000000000000000000);
            ("1399999999999999999999999999999999999999.99999999999999999999999e-38", 14000000000000000000);
            ("139999999999999999999999999999999999999.999999999999999999999999e-37", 14000000000000000000);
            ("13999999999999999999999999999999999999.9999999999999999999999999e-36", 14000000000000000000);
            ("1399999999999999999999999999999999999.99999999999999999999999999e-35", 14000000000000000000);
            ("139999999999999999999999999999999999.999999999999999999999999999e-34", 14000000000000000000);
            ("13999999999999999999999999999999999.9999999999999999999999999999e-33", 14000000000000000000);
            ("1399999999999999999999999999999999.99999999999999999999999999999e-32", 14000000000000000000);
            ("139999999999999999999999999999999.999999999999999999999999999999e-31", 14000000000000000000);
            ("13999999999999999999999999999999.9999999999999999999999999999999e-30", 14000000000000000000);
            ("1399999999999999999999999999999.99999999999999999999999999999999e-29", 14000000000000000000);
            ("139999999999999999999999999999.999999999999999999999999999999999e-28", 14000000000000000000);
            ("13999999999999999999999999999.9999999999999999999999999999999999e-27", 14000000000000000000);
            ("1399999999999999999999999999.99999999999999999999999999999999999e-26", 14000000000000000000);
            ("139999999999999999999999999.999999999999999999999999999999999999e-25", 14000000000000000000);
            ("13999999999999999999999999.9999999999999999999999999999999999999e-24", 14000000000000000000);
            ("1399999999999999999999999.99999999999999999999999999999999999999e-23", 14000000000000000000);
            ("139999999999999999999999.999999999999999999999999999999999999999e-22", 14000000000000000000);
            ("13999999999999999999999.9999999999999999999999999999999999999999e-21", 14000000000000000000);
            ("1399999999999999999999.99999999999999999999999999999999999999999e-20", 14000000000000000000);
            ("139999999999999999999.999999999999999999999999999999999999999999e-19", 14000000000000000000);
            ("13999999999999999999.9999999999999999999999999999999999999999999e-18", 14000000000000000000);
            ("1399999999999999999.99999999999999999999999999999999999999999999e-17", 14000000000000000000);
            ("139999999999999999.999999999999999999999999999999999999999999999e-16", 14000000000000000000);
            ("13999999999999999.9999999999999999999999999999999999999999999999e-15", 14000000000000000000);
            ("1399999999999999.99999999999999999999999999999999999999999999999e-14", 14000000000000000000);
            ("139999999999999.999999999999999999999999999999999999999999999999e-13", 14000000000000000000);
            ("13999999999999.9999999999999999999999999999999999999999999999999e-12", 14000000000000000000);
            ("1399999999999.99999999999999999999999999999999999999999999999999e-11", 14000000000000000000);
            ("139999999999.999999999999999999999999999999999999999999999999999e-10", 14000000000000000000);
            ("13999999999.9999999999999999999999999999999999999999999999999999e-9", 14000000000000000000);
            ("1399999999.99999999999999999999999999999999999999999999999999999e-8", 14000000000000000000);
            ("139999999.999999999999999999999999999999999999999999999999999999e-7", 14000000000000000000);
            ("13999999.9999999999999999999999999999999999999999999999999999999e-6", 14000000000000000000);
            ("1399999.99999999999999999999999999999999999999999999999999999999e-5", 14000000000000000000);
            ("139999.999999999999999999999999999999999999999999999999999999999e-4", 14000000000000000000);
            ("13999.9999999999999999999999999999999999999999999999999999999999e-3", 14000000000000000000);
            ("1399.99999999999999999999999999999999999999999999999999999999999e-2", 14000000000000000000);
            ("139.999999999999999999999999999999999999999999999999999999999999e-1", 14000000000000000000);
            ("13.9999999999999999999999999999999999999999999999999999999999999e0", 14000000000000000000);
            ("1.39999999999999999999999999999999999999999999999999999999999999e1", 14000000000000000000);
            ("0.139999999999999999999999999999999999999999999999999999999999999e2", 14000000000000000000);
            ("0.0139999999999999999999999999999999999999999999999999999999999999e3", 14000000000000000000);

            ("170141183460469231731687303715884105727100e-21", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371588410572710e-20", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037158841057271e-19", 170141183460469231731687303715884105727);
            ("170141183460469231731687303715884105727.1e-18", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371588410572.71e-17", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037158841057.271e-16", 170141183460469231731687303715884105727);
            ("170141183460469231731687303715884105.7271e-15", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371588410.57271e-14", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037158841.057271e-13", 170141183460469231731687303715884105727);
            ("170141183460469231731687303715884.1057271e-12", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371588.41057271e-11", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037158.841057271e-10", 170141183460469231731687303715884105727);
            ("170141183460469231731687303715.8841057271e-9", 170141183460469231731687303715884105727);
            ("17014118346046923173168730371.58841057271e-8", 170141183460469231731687303715884105727);
            ("1701411834604692317316873037.158841057271e-7", 170141183460469231731687303715884105727);
            ("170141183460469231731687303.7158841057271e-6", 170141183460469231731687303715884105727);
            ("17014118346046923173168730.37158841057271e-5", 170141183460469231731687303715884105727);
            ("1701411834604692317316873.037158841057271e-4", 170141183460469231731687303715884105727);
            ("170141183460469231731687.3037158841057271e-3", 170141183460469231731687303715884105727);
            ("17014118346046923173168.73037158841057271e-2", 170141183460469231731687303715884105727);
            ("1701411834604692317316.873037158841057271e-1", 170141183460469231731687303715884105727);
            ("170141183460469231731.6873037158841057271e0", 170141183460469231731687303715884105727);
            ("17014118346046923173.16873037158841057271e1", 170141183460469231731687303715884105727);
            ("1701411834604692317.316873037158841057271e2", 170141183460469231731687303715884105727);
            ("170141183460469231.7316873037158841057271e3", 170141183460469231731687303715884105727);
            ("17014118346046923.17316873037158841057271e4", 170141183460469231731687303715884105727);
            ("1701411834604692.317316873037158841057271e5", 170141183460469231731687303715884105727);
            ("170141183460469.2317316873037158841057271e6", 170141183460469231731687303715884105727);
            ("17014118346046.92317316873037158841057271e7", 170141183460469231731687303715884105727);
            ("1701411834604.692317316873037158841057271e8", 170141183460469231731687303715884105727);
            ("170141183460.4692317316873037158841057271e9", 170141183460469231731687303715884105727);
            ("17014118346.04692317316873037158841057271e10", 170141183460469231731687303715884105727);
            ("1701411834.604692317316873037158841057271e11", 170141183460469231731687303715884105727);
            ("170141183.4604692317316873037158841057271e12", 170141183460469231731687303715884105727);
            ("17014118.34604692317316873037158841057271e13", 170141183460469231731687303715884105727);
            ("1701411.834604692317316873037158841057271e14", 170141183460469231731687303715884105727);
            ("170141.1834604692317316873037158841057271e15", 170141183460469231731687303715884105727);
            ("17014.11834604692317316873037158841057271e16", 170141183460469231731687303715884105727);
            ("1701.411834604692317316873037158841057271e17", 170141183460469231731687303715884105727);
            ("170.1411834604692317316873037158841057271e18", 170141183460469231731687303715884105727);
            ("17.01411834604692317316873037158841057271e19", 170141183460469231731687303715884105727);
            ("1.701411834604692317316873037158841057271e20", 170141183460469231731687303715884105727);
            ("0.1701411834604692317316873037158841057271e21", 170141183460469231731687303715884105727);
            ("0.01701411834604692317316873037158841057271e22", 170141183460469231731687303715884105727);
            ("0.001701411834604692317316873037158841057271e23", 170141183460469231731687303715884105727);
            // Negative cases are also checked.
        },
    };
    Ok(())
}

#[test]
fn from_bad_str() -> Result<()> {
    test_fixed_point! {
        case (bad_str: &str) => {
            let exact = FixedPoint::from_str_exact(bad_str);
            let inexact: Result<FixedPoint, _> = bad_str.parse();
            assert!(exact.is_err(), "exact must not parse '{}'", bad_str);
            assert!(inexact.is_err(), "inexact must not parse '{}'", bad_str);

            #[cfg(feature = "serde")]
            assert!(serde_json::from_str::<FixedPoint>(&format!("\"{}\"", bad_str)).is_err());
        },
        all {
            ("");
            ("7.02ee5");
            ("7.02eE5");
            ("7.-02eE5");
            ("a.12");
            ("12.a");
            ("100000000000000000000000");
            ("170141183460469231731687303715.884105728");
            ("170141183460469231731.687303715884105728");
            ("170141183460469231731.6873037158841057275");
            ("-170141183460469231731.687303715884105729");
            ("-170141183460469231731.6873037158841057285");

            ("100000000000000000000000e0");
            ("170141183460469231731687303715.884105728e0");
            ("170141183460469231731.687303715884105728e0");
            ("170141183460469231731.6873037158841057275e0");
            ("-170141183460469231731.687303715884105729e0");
            ("-170141183460469231731.6873037158841057285e0");
        },
        fp64 {
            ("9223372036.854775808");
            ("9223372036.8547758075");
            ("-9223372036.854775809");
            ("-9223372036.8547758085");

            ("9223372036.854775808e0");
            ("9223372036.8547758075e0");
            ("-9223372036.854775809e0");
            ("-9223372036.8547758085e0");
        },
    };
    Ok(())
}

#[cfg(feature = "i128")]
proptest! {
    #[test]
    fn string_roundtrip(x in any::<i128>()) {
        type FixedPoint128 = fixnum::FixedPoint<i128, typenum::U18>;

        let expected = FixedPoint128::from_bits(x);
        let string = expected.to_string();

        let exact = FixedPoint128::from_str_exact(&string).unwrap();
        let inexact: FixedPoint128 = string.parse().unwrap();

        prop_assert_eq!(inexact, expected);
        prop_assert_eq!(exact, expected);
    }
}
